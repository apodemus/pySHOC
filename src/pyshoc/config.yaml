# ---------------------------------------------------------------------------- #
# Configuration file for pyshoc
# {version}
# ---------------------------------------------------------------------------- #

# ---------------------------------------------------------------------------- #
# prefer SI based naming convention for telescopes eg: "1.9m" over "74in"

preferences:
    metric_names:           True
    empty_filter_string:    ‚àÖ

# ---------------------------------------------------------------------------- #
# Folder structure for pipeline results.

# Folder locations can be templated by using $ references in paths eg: $SECTION/
# substitutes the value of "folder" keyword under "section" header.
# Additionally, $HDU can be used for substitution the base name of the fits file
# eg: "20210410.0030", and $DATE for nightly results folder eg. "2021-04-10"

folders:
    output:     .pyshoc # root folder name default (if not provided by user at cli)
    cache:      .cache  # cache location (relative to output)

# Remaining folder structures is defined per section below.
# These are the default locations relative to the output folder above:
#     info:           info/
#     logs:           $INFO/logs
#     plots:          plots/
#     sample_images:  $PLOTS/sample_images
#     registry:       reg/
#     phot:           phot/
#     tracking:       $PHOT/tracking/$HDU
#     lightcurves:    $PHOT/lightcurves


# ---------------------------------------------------------------------------- #
# Console output styling

console:
    banner:
        show:       True
        format: |
            {{python:|B,darkgreen}: <{width}}
            {{now:|B,darkgreen}: <{width}}
            {logo}

            {{subtitle:|B,purple}: >{width}}
            {v{version}: >{width}|Bc}
        subtitle:   Photometry Pipeline
        fg:         [bold, blue]
        linestyle:  ['-', bold]
        linecolor:  teal
        width:      Null

    progress:
        bar_format: >-
            {{desc}: {percentage:3.0f}%{bar}{n_fmt}/{total_fmt}:|green}
            {rate_fmt:|gold}
            {elapsed:|cyan} eta {remaining:|cyan}
        ascii: " ‚ï∏‚îÅ"
        # unit:  " frames"

    colors:
        flat: cornflowerblue
        dark: tan

    cutouts:
        title:          "Source image cutouts: {hdu.file.name:|c}"
        title_align:    <
        title_style:    [B, _]
        extend:         3
        statistics:     [com, flux, areas, roundness]

    products:
        title_style:
            bg:     darkgreen
            fg:     [lightgrey, B, _]
        header_style:
            bg:     lightgreen
            fg:     [darkslategrey, B]


# ---------------------------------------------------------------------------- #
# Logging

logging:
    filename:         $INFO/logs/main.log
    # file sink
    file:
        level:      debug
        rotation:   2Mb
        retention:  1 month
        format:  >-  # {time:YYYY-MM-DD HH:mm:ss zz}
            {time:HH:mm:ss!UTC}|
            {name}.{function}:{line:d}|
            {level.name}: {message}

    # Console logging sink
    console:
        level:  info
        catch:  False
        # log message format
        format: >- # -  chomping indicator strips end newlines
            {elapsed:s|Bb}|
            {{{name}.{function}:s|green}:{line:d|orange}: <52}{level.icon}
            {{message}:|{style}}
        # sectioning format
        section: |

            {0:‚îÅ<{width}}
            {level.icon} {{level.name}: {message}:|B,teal}
            {0:‚îÅ<{width}}
        # repeated log message
        repeats: |
            { ‚§∑ [Previous {n_messages} {n_repeats} in {t}]:|kB}

        # level icons
        icons:
            section:    üåë
            success:    üöÄ
            info:       üåå
            debug:      üîß
            warning:    üö®
            error:      üî•
            critical:   üí•

    # library activation
    activation:
        pyshoc:                     1
        pyshoc.headers.convert:     0
        obstools:                   1
        mpl_multitab:               1
        recipes:                    1
        recipes.io.utils:           0
        recipes.decorators.base:    0
        motley.formatter:           0
        motley.table.xlsx:          1
        scrawl.moves.machinery:     0


# ---------------------------------------------------------------------------- #
# Tables

tabulate:
    campaign:
        row_nrs: 1
        summary: True
        title_style:
            fg: [bold, underline]
            bg: 'darkslategrey'
        too_wide: False

    obs_groups:
        title_style:
            fg: [teal, underline, bold]
            # bg: 'darkslategrey'
        title_align: '<'

# ---------------------------------------------------------------------------- #
# Information / Overview Data Products

info:
    folder:         info/
    filenames:
        # pipeline summary info
        headers:        headers/$HDU.txt
        obslog:         observing-log.tex

    spreadsheets:
        filenames:
            # These can be separate files if you wish
            campaign:       info.xlsx::Campaign Info
            overview:       info.xlsx::Overview Products
            by_file:        info.xlsx::Data Products by File
            by_date:        info.xlsx::Data Products by Date

        style:
            data:
                font:
                    name:       Ubuntu Mono
                    size:       10

            title:
                font:
                    size:           14
                    bold:           True
                alignment:
                    horizontal:     center
                    vertical:       center
                    wrap_text:      True
                border:
                    bottom:         double

            headers:
                font:
                    size:           12
                    bold:           True
                alignment:
                    horizontal:     center
                    vertical:       center
                    wrap_text:      True
                # border:
                #     bottom:         double

            groups:
                border:
                    right:          double

            units:
                # font:
                alignment:
                    horizontal:     center
                    vertical:       top
                border: 
                    bottom:         double

            totals:
                font:
                    bold:   True
                border:
                    bottom: thin
                    top:    thin

            bottomrule :    double


# ---------------------------------------------------------------------------- #
# Remote file sync

remote:
    username:           Null
    server:             astro.cape.saao.ac.za
    filenames:
        rsync_script:           $INFO/rsync-remote.sh
        rsync_files:            $INFO/remote-files.txt


# ---------------------------------------------------------------------------- #
# Calibration Database

calibration:
    # Location of calibration database
    # ~/.config/pyshoc/caldb
    # /media/Oceanus/work/Observing/data/SHOC/calibration/
    folder:     null

    # darks:
    #     filename_format: {obstype}-{camera}-{binning}-{readout}
    #     combine:         median

    # flats:
    #     filename_format: {obstype}-{t.date:d}-{telescope}-{camera}-{binning}-{filters}


# ---------------------------------------------------------------------------- #
# Plotting

plotting:
    # global plotting config. Specific plots are configurable per section below

    # GUI
    gui:
        title:      pySHOC Photometry Pipeline GUI
        pos :       N
        delay:      True

    # matplotlib rc params
    cmap:               cmr.voltage
    font:
        size:           14
    axes:
        labelweight:    bold



# aliases
# plots: *plotting
# plotting: *plotting


# ---------------------------------------------------------------------------- #
# Sample Image Statistics

samples:
    tab:                [Sample Images] # Detection
    header:             Sample Images
    folder:             $REGISTRY/samples/
    filename:           $HDU$FRAMES.png

    params:
        stat:               median
        min_depth:          10          # minimun simulated integration time (seconds)
        n_intervals:        1
        subset:             Null        # eg: 1000 for sample from first 1000

    plots:
        # detections
        contours:
            cmap:   cmr.pride
            lw:     1.5

        labels:
            offset: [4, 4]
            size:   10
            color:  w
            emboss: [1, k]

        # Sample thumbnails plot config
        thumbnails:
            raw:
                tab:            [Overview, Thumbnails, Raw]
                filename:       thumbnails/thumbnails.png
                overwrite:      False
                figsize:        [9, 7.5]

                plims:          [0.25, 99.9]
                title_kws:
                    color:          w
                    size:           xx-small
                    fontweight:     bold


            calibrated:
                tab:            [Overview, Thumbnails, Calibrated]
                filename:       thumbnails/thumbnails-cal.png
                overwrite:      Null


# ---------------------------------------------------------------------------- #
# Source Detection

detection: &source_detection
    algorithm:      sigma_threshold
    snr:            3

    npixels:        5
    edge_cutoff:    3
    edge_fraction:  0.5
    monolithic:     False
    roundness:      Null    # !!python/tuple [0.5, 1.75]
    dilate:         2
    deblend:        True

    report:
        cutouts: True

# aliases
# detect:          *source_detection #
# source_detection:   *source_detection #


# ---------------------------------------------------------------------------- #
# Image Registration (wcs)

registration:

    folder:         registry/
    filenames:
        registry:   registry.pkl
        params:     params.npy

    params:
        survey:         dss
        fov_stretch:    1.65
        fit_angle:      True

    drizzle:
        show:           True
        tab:            [Overview, Drizzle]
        filename:       drizzle.fits
        pixfrac:        0.5

    plots:
        mosaic:
            show:       True
            tab:        [Overview, Mosaic]
            filename:   $REGISTRY/mosaic/mosaic.$TEL.png

            cmap:       cmr.chroma
            alpha:      0.5

        alignment:
            show:       True
            tab:        [Registration, Alignment Fit]
            filename:   $REGISTRY/alignment/$HDU.aligned.png

        clusters:
            show:               True
            tab:                [Registration, Source IDs]
            filename:           $REGISTRY/source-ids.$TEL.png

            centres:            True
            frames:             True
            nrs:                True
            show_bandwidth:     True
            trim_labels:        False
# alias
# reg: *image_registration


# ---------------------------------------------------------------------------- #
# Camera Tracking

tracking:
    # gui tab
    tab:      Tracking
    # ------------------------------------------------------------------------ #
    # source tracking data files
    folder:     $PHOT/tracking/$HDU/
    filenames:
        measurements:       centroids.dat       # (n, nstats, nsources, 2)
        coords:             coords.dat          # (nsources, 2) structured ['xy', 'std']
        frame_info:         frame-info.dat      # (n, 2)        structured
        source_info:        source-info.dat     # (n, nsources) structured
        feature_weights:    feature-weights.dat # (nstats, 1, 1)
        source_weights:     source-weights.dat  # nsources

    # ------------------------------------------------------------------------ #
    params:
        dilate:             2
        circularize:        True
        njobs:              1

        centroids:
            # features used for tracking
            com:            1
            peak:
                upsample:   1
                # filter: lanczos
                # note, upsampling will siginificantly affect compute times

        pre_subtract:       True
        # subtract background from image prior to computing features
        bg:                 median
        # statistic used for background

        precision:          0.5
        # Required positional accuracy in pixels
        weights:            snr
        # Per-source weights for frame offset calculation. Use "snr" for
        # signal-to-noise weighting.

        cutoffs:
            edge:           0
            snr:            3.
            # Sources with signal-to-noise ratio less than this will not be
            # considered when solving for image dither
            distance:       10
            # For outlier detection: maximum distance allowed for point measurements
            # from centre of distribution.
            saturation:     95
            # If we know the saturation value of the CCD chip, we discard pixels above
            # this percentage of the saturation value

        compute:
            centres: [0 , 1000, 100 ]

    # ------------------------------------------------------------------------ #
    table:
        title:          Measured source coordinates
        title_style:
            fg:         [B,  _,  w]
            bg:         darkslategrey
        col_head_style:
            fg:         [B,  _,  black]
            bg:         grey
        col_head_align: ^
        precision:      3
        align:          r
        row_nrs:        True
        max_rows:       25


    # ------------------------------------------------------------------------ #
    plot:   True
    plots:
        folder:     plots/

        centroids:
            com:              [r, +, Centre of Mass]
            peak:             [m, ^, Peak]
            avg:              [k, x, Weighted Centroid]
            # NOTE: avg sould be last

        labels:
            offset: [6, 6]
            color:  w
            size:   10
            # fontweight:bold

        positions:
        # -------------------------------------------------------------------- #
            filename:           positions-$SOURCE.png

            figsize:            [12, 6.5]
            legend:             False
            show:               [avg, weights, caption]  #  nulls, pixel

            density:
                cmap:           null
                tessellation:   hex
                min_count:      3

            scatter:
                marker:     x
                s:          5
                ls:         ''
                color:      null
                zorder:     1
                alpha:      0.35

            title:
                size:       13
                fontweight: bold
                pad:        10

            caption:
                pos:    [0.075, 0.01]
                text:   >-
                    $x_0 = {x:s}$
                    $y_0 = {y:s}$
                va:     bottom
                ha:     left
                bbox:       # these are matplotlib.patch.Patch properties
                    boxstyle:    round
                    facecolor:  lightgrey

            cbar:
                # shrink: 0.9
                pad:    0.01
                label0:  Counts
                label1:  Counts (Recentred)

            pixel:
                lw:         0.75
                ls:         '--'
                fc:         none
                ec:         lime
                zorder:     100

            precision:
                lw:         0.75
                ls:         '--'
                fc:         none
                ec:         darkgreen
                zorder:     100

        # -------------------------------------------------------------------- #
        time_series:
            tab:            Time Series
            filename:       displacement-ts.png
            figsize:        [12, 5]


# ---------------------------------------------------------------------------- #
# Photometry

phot:
    folder:         phot/

    apertures:
        shapes:     [contour, elliptical]
        optimize:   True


# ---------------------------------------------------------------------------- #
# Time Series Analysis

lightcurves:
    tab:            Light Curves
    header:         Light Curves
    folder:         $PHOT/lightcurves/
    formats:        [txt, npy, png, pdf]

    plots:
        # save
        # formats:    []

        # figure
        subplotspec:
            top:        0.81
            bottom:     0.1
            left:       0.065
            right:      0.94

        # time series plot parametes
        plims:          [-0.1, 99.99]
        xlabel:
            top:        Time (UTC)
            bottom:     Œît (s)
            pad:        -17.5
        ylabel:         Relative Flux

    # Data Products by file
    # ------------------------------------------------------------------------ #
    by_file:
        folder:     by_file/$HDU

        # Raw light curve
        raw:
            filename:   $HDU.raw.$EXT
            title:      Raw contour aperture light curve for {}.

            acf:
                filename: $HDU.raw.acf.{npy,pdf,png}

        # Flag outliers
        flagged:
            filename:   $HDU.oflag.$EXT
            title:      Outlier-flagged contour aperture light curve for {}.

            # parameters for outlier detection
            params:
                # method:   gESD
                nwindow:    1000
                noverlap:   50%
                kmax:       0.1%

        # Scaled by median flux of reference source
        diff0:
            title:      Median scaled contour aperture light curve for {}.
            filename:   $HDU.diff0.$EXT

            plot:
                hist:   True

        # Differential with Total Variational (TV) smoothing
        diff:
            title:      Differential light curve (via total variational smoothing) for {}.
            filename:   $HDU.diff.$EXT
            plot:
                hist:   True

            # Parameters for variational smoother
            params:
                nwindow:        1000
                noverlap:       10%
                smoothing:      0.1

            acf:
                filename: $HDU.diff.acf.{npy,pdf,png}

        # decorrelate  via Maximum entropy spectrum.
        # Do by file since more likely heteroscedastic
        decor:
            title:      Decorrelated light curve (via Maximum Entropy whitening) for {}.
            filename:   $HDU.decor.$EXT

            params:
                # method for choosing p in AR(p)
                method:     FPE # Akaike Final prediction Error

            acf:
                filename: $HDU.decor.acf.{npy,pdf,png}

            # Concatenate to produce nightly light curves
            concat:
                title:      Nightly decorrelated contour aperture light curve for {}.
                filename:   $LIGHTCURVES/by_date/$DATE/$DATE.decor.$EXT
                overwrite:  True

    # Data Products by date
    # ------------------------------------------------------------------------ #
    by_date:
        folder:         by_date/$DATE
        formats:        [npy, pdf, png]

        # sde:
        # Spectral Analysis
        periodogram:
            title:      Periodogram
            filename:   $DATE.pg.$EXT

        lombscargle:
            title:      Lomb-Scargle Periodogram
            filename:   $DATE.ls.$EXT

        welch:
            title:      Welch Periodogram
            filename:   $DATE.welch.$EXT

        tfr:
            title:      Time Frequency Representation
            filename:   $DATE.tfr.$EXT

    # Data Products by orbital cycle (ephemeris required)
    # ------------------------------------------------------------------------ #
    # Phase folded light curves (If ephemeris available)
    by_cycle:
        # ephemeris:    Eg:
        folder:         by_cycle/
        filename:       E$CYCLE.lc.$EXT

        stacked:
            title:      Orbit phased light curves for {}
            filename:   lcs-stacked.png


        phased:
            title:      Orbit phased light curve for {}
            filename:   lcs-phased.png

            params:
                bins:           360
                statistics:
                    median:     'o'
                    # mad:        '|'
                    p5, p95:    '-.'
                    min, max:   ':'

        # # Spectral Analysis
        # periodogram:
        #     title:      'Periodogram'
        #     filename:   E$CYCLE.pg.txt
        #     plot:       True

        # lombscargle:
        #     title:      'Lomb-Scargle Periodogram'
        #     filename:   E$CYCLE.ls.txt
        #     plot:       True

        # welch:
        #     title:      'Welch Periodogram'
        #     filename:   E$CYCLE.welch.txt
        #     plot:       True


# ---------------------------------------------------------------------------- #
sde:
    header:    Spectral Density Estimates

